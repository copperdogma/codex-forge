{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://fighting-fantasy-engine.github.io/schema/gamebook.json",
  "title": "Fighting Fantasy Gamebook JSON Schema",
  "description": "Schema specification for Fighting Fantasy gamebook JSON format. This is the required format that the PDF-to-JSON parser must produce.",
  "type": "object",
  "required": [
    "metadata",
    "sections"
  ],
  "additionalProperties": true,
  "properties": {
    "metadata": {
      "type": "object",
      "required": [
        "title",
        "startSection",
        "formatVersion"
      ],
      "additionalProperties": true,
      "properties": {
        "title": {
          "type": "string",
          "description": "Book title"
        },
        "author": {
          "type": "string",
          "description": "Book author (optional)"
        },
        "startSection": {
          "type": "string",
          "description": "Starting section ID (usually '1')"
        },
        "formatVersion": {
          "type": "string",
          "description": "Format version (e.g., '1.0.0')"
        },
        "validatorVersion": {
          "type": "string",
          "description": "Validator version expected to validate this gamebook"
        }
      }
    },
    "sections": {
      "type": "object",
      "description": "All sections in the gamebook, keyed by section ID",
      "patternProperties": {
        "^.+$": {
          "$ref": "#/definitions/GamebookSection"
        }
      }
    }
  },
  "definitions": {
    "SectionId": {
      "type": "string",
      "description": "Unique section identifier (e.g., '1', '270', 'S003')"
    },
    "GamebookSection": {
      "type": "object",
      "required": [
        "id",
        "presentation_html",
        "isGameplaySection",
        "type"
      ],
      "additionalProperties": true,
      "properties": {
        "id": {
          "$ref": "#/definitions/SectionId"
        },
        "presentation_html": {
          "type": "string",
          "description": "Cleaned HTML content for display (final narrative payload)"
        },
        "pageStart": {
          "type": "number",
          "description": "Starting page number (optional, for citation)"
        },
        "pageEnd": {
          "type": "number",
          "description": "Ending page number (optional, for citation)"
        },
        "isGameplaySection": {
          "type": "boolean",
          "description": "true = gameplay section (has sequence), false = non-gameplay content (cover, rules, etc.)"
        },
        "type": {
          "type": "string",
          "enum": [
            "section",
            "front_cover",
            "back_cover",
            "title_page",
            "publishing_info",
            "toc",
            "intro",
            "rules",
            "adventure_sheet",
            "template",
            "background"
          ],
          "description": "Section type categorizing the content"
        },
        "status": {
          "type": "string",
          "enum": [
            "death",
            "victory",
            "defeat"
          ],
          "description": "Optional ending status for the section"
        },
        "end_game": {
          "type": "boolean",
          "description": "Optional end-game marker (suppresses no-choice warnings)"
        },
        "sequence": {
          "type": "array",
          "description": "Ordered gameplay sequence events for this section",
          "items": {
            "$ref": "#/definitions/SequenceEvent"
          }
        },
        "metadata": {
          "type": "object",
          "description": "Additional section metadata",
          "properties": {
            "title": {
              "type": "string",
              "description": "Section title if available"
            }
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "isGameplaySection": {
                "const": true
              }
            }
          },
          "then": {
            "required": [
              "sequence"
            ]
          }
        },
        {
          "not": {
            "required": [
              "navigation"
            ]
          }
        },
        {
          "not": {
            "required": [
              "combat"
            ]
          }
        },
        {
          "not": {
            "required": [
              "items"
            ]
          }
        },
        {
          "not": {
            "required": [
              "statModifications"
            ]
          }
        },
        {
          "not": {
            "required": [
              "statChanges"
            ]
          }
        },
        {
          "not": {
            "required": [
              "diceChecks"
            ]
          }
        },
        {
          "not": {
            "required": [
              "deathConditions"
            ]
          }
        }
      ]
    },
    "SequenceEvent": {
      "oneOf": [
        {
          "$ref": "#/definitions/ChoiceEvent"
        },
        {
          "$ref": "#/definitions/StatChangeEvent"
        },
        {
          "$ref": "#/definitions/StatCheckEvent"
        },
        {
          "$ref": "#/definitions/TestLuckEvent"
        },
        {
          "$ref": "#/definitions/ItemEvent"
        },
        {
          "$ref": "#/definitions/ItemCheckEvent"
        },
        {
          "$ref": "#/definitions/StateCheckEvent"
        },
        {
          "$ref": "#/definitions/ConditionalEvent"
        },
        {
          "$ref": "#/definitions/CombatEvent"
        },
        {
          "$ref": "#/definitions/DeathEvent"
        },
        {
          "$ref": "#/definitions/CustomEvent"
        }
      ]
    },
    "Condition": {
      "oneOf": [
        {
          "$ref": "#/definitions/ItemCondition"
        }
      ]
    },
    "ItemCondition": {
      "type": "object",
      "required": [
        "kind",
        "itemName"
      ],
      "properties": {
        "kind": {
          "const": "item"
        },
        "itemName": {
          "type": "string"
        },
        "operator": {
          "type": "string",
          "enum": [
            "has",
            "missing"
          ]
        }
      }
    },
    "ConditionalEvent": {
      "type": "object",
      "required": [
        "kind",
        "condition",
        "then"
      ],
      "properties": {
        "kind": {
          "const": "conditional"
        },
        "condition": {
          "$ref": "#/definitions/Condition"
        },
        "then": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/SequenceEvent"
          }
        },
        "else": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/SequenceEvent"
          }
        }
      }
    },
    "OutcomeRef": {
      "type": "object",
      "properties": {
        "targetSection": {
          "$ref": "#/definitions/SectionId"
        },
        "terminal": {
          "$ref": "#/definitions/TerminalOutcome"
        }
      },
      "oneOf": [
        {
          "required": [
            "targetSection"
          ]
        },
        {
          "required": [
            "terminal"
          ]
        }
      ]
    },
    "ChoiceEvent": {
      "type": "object",
      "required": [
        "kind",
        "targetSection"
      ],
      "properties": {
        "kind": {
          "const": "choice"
        },
        "targetSection": {
          "$ref": "#/definitions/SectionId"
        },
        "choiceText": {
          "type": "string"
        },
        "effects": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ItemEvent"
          }
        }
      }
    },
    "StatChangeEvent": {
      "type": "object",
      "required": [
        "kind",
        "stat",
        "amount"
      ],
      "properties": {
        "kind": {
          "const": "stat_change"
        },
        "stat": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          ]
        },
        "amount": {
          "type": [
            "number",
            "string"
          ]
        },
        "permanent": {
          "type": "boolean"
        }
      }
    },
    "StatCheckEvent": {
      "type": "object",
      "required": [
        "kind",
        "stat"
      ],
      "properties": {
        "kind": {
          "const": "stat_check"
        },
        "stat": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          ]
        },
        "diceRoll": {
          "type": "string"
        },
        "passCondition": {
          "type": "string"
        },
        "failCondition": {
          "type": "string"
        },
        "pass": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "fail": {
          "$ref": "#/definitions/OutcomeRef"
        }
      }
    },
    "TestLuckEvent": {
      "type": "object",
      "required": [
        "kind"
      ],
      "properties": {
        "kind": {
          "const": "test_luck"
        },
        "lucky": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "unlucky": {
          "$ref": "#/definitions/OutcomeRef"
        }
      }
    },
    "ItemEvent": {
      "type": "object",
      "required": [
        "kind",
        "action",
        "name"
      ],
      "properties": {
        "kind": {
          "const": "item"
        },
        "action": {
          "type": "string",
          "enum": [
            "add",
            "remove",
            "reference"
          ]
        },
        "name": {
          "type": "string"
        }
      }
    },
    "ItemCheckEvent": {
      "type": "object",
      "required": [
        "kind"
      ],
      "properties": {
        "kind": {
          "const": "item_check"
        },
        "itemName": {
          "type": "string"
        },
        "has": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "missing": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "itemsAll": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 2
        }
      }
    },
    "CombatEvent": {
      "type": "object",
      "required": [
        "kind",
        "enemies"
      ],
      "properties": {
        "kind": {
          "const": "combat"
        },
        "enemies": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/CombatEncounter"
          }
        },
        "outcomes": {
          "type": "object",
          "properties": {
            "win": {
              "$ref": "#/definitions/OutcomeRef"
            },
            "lose": {
              "$ref": "#/definitions/OutcomeRef"
            },
            "escape": {
              "$ref": "#/definitions/OutcomeRef"
            }
          },
          "additionalProperties": false
        }
      }
    },
    "DeathEvent": {
      "type": "object",
      "required": [
        "kind",
        "outcome"
      ],
      "properties": {
        "kind": {
          "const": "death"
        },
        "outcome": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "CustomEvent": {
      "type": "object",
      "required": [
        "kind"
      ],
      "properties": {
        "kind": {
          "const": "custom"
        },
        "data": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "TerminalOutcome": {
      "type": "object",
      "required": [
        "kind"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "death",
            "victory",
            "defeat",
            "end"
          ],
          "description": "Terminal outcome type"
        },
        "message": {
          "type": "string",
          "description": "Optional narrative message"
        }
      }
    },
    "CombatEncounter": {
      "type": "object",
      "required": [
        "enemy",
        "skill",
        "stamina"
      ],
      "properties": {
        "enemy": {
          "type": "string",
          "description": "Creature name"
        },
        "skill": {
          "type": "number",
          "description": "Combat Skill value"
        },
        "stamina": {
          "type": "number",
          "description": "Stamina (hit points)"
        },
        "special_rules": {
          "type": "string",
          "description": "Optional special combat rules"
        },
        "allow_escape": {
          "type": "boolean",
          "description": "Whether escape is allowed from this combat"
        }
      }
    },
    "CreatureStats": {
      "type": "object",
      "required": [
        "name",
        "skill",
        "stamina"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Creature name"
        },
        "skill": {
          "type": "number",
          "description": "Combat Skill value"
        },
        "stamina": {
          "type": "number",
          "description": "Stamina (hit points)"
        },
        "specialRules": {
          "type": "array",
          "description": "Optional special combat rules",
          "items": {
            "type": "string"
          }
        },
        "allowEscape": {
          "type": "boolean",
          "description": "Whether escape is allowed from this combat"
        },
        "escapeSection": {
          "$ref": "#/definitions/SectionId",
          "description": "Section to navigate to if player escapes"
        }
      }
    },
    "ItemReference": {
      "type": "object",
      "required": [
        "name",
        "action"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Item name (as it appears in text)"
        },
        "action": {
          "type": "string",
          "enum": [
            "add",
            "remove",
            "check",
            "reference"
          ],
          "description": "Item action: add to inventory, remove from inventory, check if player has, or just reference"
        }
      }
    },
    "StatModification": {
      "type": "object",
      "required": [
        "stat",
        "amount"
      ],
      "properties": {
        "stat": {
          "type": "string",
          "enum": [
            "skill",
            "stamina",
            "luck"
          ],
          "description": "Stat name: 'skill', 'stamina', or 'luck'"
        },
        "amount": {
          "type": "number",
          "description": "Amount to change (can be negative)"
        },
        "permanent": {
          "type": "boolean",
          "description": "Whether this is a permanent modification (affects initial value)",
          "default": false
        }
      }
    },
    "DeathCondition": {
      "type": "object",
      "required": [
        "trigger"
      ],
      "properties": {
        "trigger": {
          "type": "string",
          "enum": [
            "stamina_zero",
            "instant_death",
            "conditional"
          ],
          "description": "Death trigger type"
        },
        "message": {
          "type": "string",
          "description": "Death message/reason"
        }
      }
    },
    "StateCheckEvent": {
      "type": "object",
      "required": [
        "kind"
      ],
      "properties": {
        "kind": {
          "const": "state_check"
        },
        "conditionText": {
          "type": "string"
        },
        "has": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "missing": {
          "$ref": "#/definitions/OutcomeRef"
        }
      }
    }
  }
}
