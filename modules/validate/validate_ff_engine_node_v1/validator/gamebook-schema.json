{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://fighting-fantasy-engine.github.io/schema/gamebook.json",
  "title": "Fighting Fantasy Gamebook JSON Schema",
  "description": "Schema specification for Fighting Fantasy gamebook JSON format. This is the required format that the PDF-to-JSON parser must produce.",
  "type": "object",
  "required": [
    "metadata",
    "sections"
  ],
  "additionalProperties": true,
  "properties": {
    "metadata": {
      "type": "object",
      "required": [
        "title",
        "startSection",
        "formatVersion"
      ],
      "additionalProperties": true,
      "properties": {
        "title": {
          "type": "string",
          "description": "Book title"
        },
        "author": {
          "type": "string",
          "description": "Book author (optional)"
        },
        "startSection": {
          "type": "string",
          "description": "Starting section ID (usually '1')"
        },
        "formatVersion": {
          "type": "string",
          "description": "Format version (e.g., '1.0.0')"
        },
        "validatorVersion": {
          "type": "string",
          "description": "Validator version expected to validate this gamebook"
        },
        "sectionCount": {
          "type": "integer",
          "minimum": 1,
          "description": "Expected numeric section count for validation (optional)"
        }
      }
    },
    "sections": {
      "type": "object",
      "description": "All sections in the gamebook, keyed by section ID",
      "patternProperties": {
        "^.+$": {
          "$ref": "#/definitions/GamebookSection"
        }
      }
    }
  },
  "definitions": {
    "SectionId": {
      "type": "string",
      "description": "Unique section identifier (e.g., '1', '270', 'S003')"
    },
    "GamebookSection": {
      "type": "object",
      "required": [
        "id",
        "presentation_html",
        "isGameplaySection",
        "type"
      ],
      "additionalProperties": true,
      "properties": {
        "id": {
          "$ref": "#/definitions/SectionId"
        },
        "presentation_html": {
          "type": "string",
          "description": "Cleaned HTML content for display (final narrative payload)"
        },
        "pageStart": {
          "type": "number",
          "description": "Starting page number (optional, for citation)"
        },
        "pageEnd": {
          "type": "number",
          "description": "Ending page number (optional, for citation)"
        },
        "isGameplaySection": {
          "type": "boolean",
          "description": "true = gameplay section (has sequence), false = non-gameplay content (cover, rules, etc.)"
        },
        "type": {
          "type": "string",
          "enum": [
            "section",
            "front_cover",
            "back_cover",
            "title_page",
            "publishing_info",
            "toc",
            "intro",
            "rules",
            "adventure_sheet",
            "template",
            "background"
          ],
          "description": "Section type categorizing the content"
        },
        "status": {
          "type": "string",
          "enum": [
            "death",
            "victory",
            "defeat"
          ],
          "description": "Optional ending status for the section"
        },
        "end_game": {
          "type": "boolean",
          "description": "Optional end-game marker (suppresses no-choice warnings)"
        },
        "sequence": {
          "type": "array",
          "description": "Ordered gameplay sequence events for this section",
          "items": {
            "$ref": "#/definitions/SequenceEvent"
          }
        },
        "metadata": {
          "type": "object",
          "description": "Additional section metadata",
          "properties": {
            "title": {
              "type": "string",
              "description": "Section title if available"
            }
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "isGameplaySection": {
                "const": true
              }
            }
          },
          "then": {
            "required": [
              "sequence"
            ]
          }
        },
        {
          "not": {
            "required": [
              "navigation"
            ]
          }
        },
        {
          "not": {
            "required": [
              "combat"
            ]
          }
        },
        {
          "not": {
            "required": [
              "items"
            ]
          }
        },
        {
          "not": {
            "required": [
              "statModifications"
            ]
          }
        },
        {
          "not": {
            "required": [
              "statChanges"
            ]
          }
        },
        {
          "not": {
            "required": [
              "diceChecks"
            ]
          }
        },
        {
          "not": {
            "required": [
              "deathConditions"
            ]
          }
        }
      ]
    },
    "SequenceEvent": {
        "oneOf": [
          {
            "$ref": "#/definitions/ChoiceEvent"
          },
          {
            "$ref": "#/definitions/StatChangeEvent"
          },
          {
            "$ref": "#/definitions/StatCheckEvent"
          },
          {
            "$ref": "#/definitions/TestLuckEvent"
          },
          {
            "$ref": "#/definitions/ItemEvent"
          },
          {
            "$ref": "#/definitions/ItemCheckEvent"
          },
          {
            "$ref": "#/definitions/StateCheckEvent"
          },
          {
            "$ref": "#/definitions/StateSetEvent"
          },
          {
            "$ref": "#/definitions/ConditionalEvent"
          },
          {
            "$ref": "#/definitions/CombatEvent"
          },
        {
          "$ref": "#/definitions/DeathEvent"
        },
        {
          "$ref": "#/definitions/InventoryStateEvent"
        },
        {
          "$ref": "#/definitions/CustomEvent"
        }
      ]
    },
    "Condition": {
      "oneOf": [
        {
          "$ref": "#/definitions/ItemCondition"
        },
        {
          "$ref": "#/definitions/CombatMetricCondition"
        }
      ]
    },
    "CombatMetricCondition": {
      "type": "object",
      "required": [
        "kind",
        "metric",
        "operator",
        "value"
      ],
      "properties": {
        "kind": {
          "const": "combat_metric"
        },
        "metric": {
          "type": "string",
          "enum": [
            "enemy_round_wins"
          ]
        },
        "operator": {
          "type": "string",
          "enum": [
            "gt",
            "gte",
            "lt",
            "lte",
            "eq"
          ]
        },
        "value": {
          "type": "number"
        }
      },
      "additionalProperties": false
    },
    "ItemCondition": {
      "type": "object",
      "required": [
        "kind",
        "itemName"
      ],
      "properties": {
        "kind": {
          "const": "item"
        },
        "itemName": {
          "type": "string"
        },
        "operator": {
          "type": "string",
          "enum": [
            "has",
            "missing"
          ]
        }
      }
    },
    "ConditionalEvent": {
      "type": "object",
      "required": [
        "kind",
        "condition",
        "then"
      ],
      "properties": {
        "kind": {
          "const": "conditional"
        },
        "condition": {
          "$ref": "#/definitions/Condition"
        },
        "then": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/SequenceEvent"
          }
        },
        "else": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/SequenceEvent"
          }
        }
      }
    },
    "OutcomeRef": {
      "type": "object",
      "properties": {
        "targetSection": {
          "$ref": "#/definitions/SectionId"
        },
        "terminal": {
          "$ref": "#/definitions/TerminalOutcome"
        }
      },
      "oneOf": [
        {
          "required": [
            "targetSection"
          ]
        },
        {
          "required": [
            "terminal"
          ]
        }
      ]
    },
    "ChoiceEvent": {
      "type": "object",
      "required": [
        "kind",
        "targetSection"
      ],
      "properties": {
        "kind": {
          "const": "choice"
        },
        "targetSection": {
          "$ref": "#/definitions/SectionId"
        },
        "choiceText": {
          "type": "string"
        },
        "effects": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ItemEvent"
          }
        }
      }
    },
    "StatChangeEvent": {
      "type": "object",
      "required": [
        "kind",
        "stat",
        "amount",
        "scope"
      ],
      "properties": {
        "kind": {
          "const": "stat_change"
        },
        "stat": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          ]
        },
        "amount": {
          "type": [
            "number",
            "string"
          ]
        },
        "scope": {
          "type": "string",
          "enum": [
            "permanent",
            "section",
            "combat",
            "round"
          ]
        },
        "reason": {
          "type": "string"
        }
      }
    },
    "StatCheckEvent": {
      "type": "object",
      "required": [
        "kind",
        "stat"
      ],
      "properties": {
        "kind": {
          "const": "stat_check"
        },
        "stat": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          ]
        },
        "diceRoll": {
          "type": "string"
        },
        "passCondition": {
          "type": "string"
        },
        "failCondition": {
          "type": "string"
        },
        "pass": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "fail": {
          "$ref": "#/definitions/OutcomeRef"
        }
      }
    },
    "TestLuckEvent": {
      "type": "object",
      "required": [
        "kind"
      ],
      "properties": {
        "kind": {
          "const": "test_luck"
        },
        "lucky": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "unlucky": {
          "$ref": "#/definitions/OutcomeRef"
        }
      }
    },
    "ItemEvent": {
      "type": "object",
      "required": [
        "kind",
        "action",
        "name"
      ],
      "properties": {
        "kind": {
          "const": "item"
        },
        "action": {
          "type": "string",
          "enum": [
            "add",
            "remove",
            "reference"
          ]
        },
        "name": {
          "type": "string"
        }
      }
    },
    "ItemCheckEvent": {
      "type": "object",
      "required": [
        "kind"
      ],
      "properties": {
        "kind": {
          "const": "item_check"
        },
        "itemName": {
          "type": "string"
        },
        "has": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "missing": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "itemsAll": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 2
        }
      }
    },
    "CombatEvent": {
      "type": "object",
      "required": [
        "kind",
        "enemies",
        "outcomes"
      ],
        "properties": {
          "kind": {
            "const": "combat"
          },
          "style": {
            "type": "string"
          },
          "mode": {
            "type": "string",
            "enum": [
              "single",
            "sequential",
            "simultaneous",
            "split-target"
          ]
        },
        "enemies": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/CombatEncounter"
          }
        },
        "rules": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/CombatRule"
          }
        },
        "modifiers": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/StatChangeEvent"
          }
        },
        "triggers": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/CombatTrigger"
          }
        },
        "outcomes": {
          "type": "object",
          "required": [
            "win"
          ],
          "properties": {
            "win": {
              "$ref": "#/definitions/OutcomeRef"
            },
            "lose": {
              "$ref": "#/definitions/OutcomeRef"
            },
            "escape": {
              "$ref": "#/definitions/OutcomeRef"
            }
          },
          "additionalProperties": false
        }
      }
    },
    "DeathEvent": {
      "type": "object",
      "required": [
        "kind",
        "outcome"
      ],
      "properties": {
        "kind": {
          "const": "death"
        },
        "outcome": {
          "$ref": "#/definitions/OutcomeRef"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "CustomEvent": {
      "type": "object",
      "required": [
        "kind"
      ],
      "properties": {
        "kind": {
          "const": "custom"
        },
        "data": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "TerminalOutcome": {
      "type": "object",
      "required": [
        "kind"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "death",
            "victory",
            "defeat",
            "end",
            "continue"
          ],
          "description": "Non-target outcome type (terminal or in-section continuation)"
        },
        "message": {
          "type": "string",
          "description": "Optional narrative message"
        }
      }
    },
      "CombatEncounter": {
        "type": "object",
        "required": [
          "enemy"
        ],
        "properties": {
          "enemy": {
            "type": "string",
            "description": "Creature name"
          },
          "skill": {
            "type": "number",
            "description": "Combat Skill value"
          },
          "stamina": {
            "type": "number",
            "description": "Stamina (hit points)"
          },
          "armour": {
            "type": "number",
            "description": "Armour (robot/vehicle durability)"
          },
          "firepower": {
            "type": "number",
            "description": "Firepower (vehicle attack)"
          },
          "speed": {
            "type": "string",
            "description": "Speed category (e.g., Slow, Medium, Fast)"
          }
        },
        "anyOf": [
          {
            "required": [
              "skill",
              "stamina"
            ]
          },
          {
            "required": [
              "skill",
              "armour"
            ]
          },
          {
            "required": [
              "firepower",
              "armour"
            ]
          }
        ]
      },
    "CombatRule": {
      "type": "object",
      "required": [
        "kind"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "fight_singly",
            "both_attack_each_round",
            "choose_target_each_round",
            "secondary_target_no_damage",
            "secondary_enemy_defense_only",
            "note"
          ]
        },
        "text": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "CombatTrigger": {
      "type": "object",
      "required": [
        "kind",
        "outcome"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "enemy_round_win",
            "no_enemy_round_wins",
            "enemy_attack_strength_total",
            "player_round_win",
            "survive_rounds"
          ]
        },
        "value": {
          "type": "number"
        },
        "count": {
          "type": "number"
        },
        "outcome": {
          "$ref": "#/definitions/OutcomeRef"
        }
      },
      "additionalProperties": false
    },
    "CreatureStats": {
      "type": "object",
      "required": [
        "name",
        "skill",
        "stamina"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Creature name"
        },
        "skill": {
          "type": "number",
          "description": "Combat Skill value"
        },
        "stamina": {
          "type": "number",
          "description": "Stamina (hit points)"
        },
        "specialRules": {
          "type": "array",
          "description": "Optional special combat rules",
          "items": {
            "type": "string"
          }
        },
        "allowEscape": {
          "type": "boolean",
          "description": "Whether escape is allowed from this combat"
        },
        "escapeSection": {
          "$ref": "#/definitions/SectionId",
          "description": "Section to navigate to if player escapes"
        }
      }
    },
    "ItemReference": {
      "type": "object",
      "required": [
        "name",
        "action"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Item name (as it appears in text)"
        },
        "action": {
          "type": "string",
          "enum": [
            "add",
            "remove",
            "check",
            "reference"
          ],
          "description": "Item action: add to inventory, remove from inventory, check if player has, or just reference"
        }
      }
    },
    "StatModification": {
      "type": "object",
      "required": [
        "stat",
        "amount",
        "scope"
      ],
      "properties": {
        "stat": {
          "type": "string",
          "enum": [
            "skill",
            "stamina",
            "luck"
          ],
          "description": "Stat name: 'skill', 'stamina', or 'luck'"
        },
        "amount": {
          "type": "number",
          "description": "Amount to change (can be negative)"
        },
        "scope": {
          "type": "string",
          "enum": [
            "permanent",
            "section",
            "combat",
            "round"
          ],
          "description": "Duration for the change"
        },
        "reason": {
          "type": "string",
          "description": "Optional explanation of the modification"
        }
      }
    },
    "DeathCondition": {
      "type": "object",
      "required": [
        "trigger"
      ],
      "properties": {
        "trigger": {
          "type": "string",
          "enum": [
            "stamina_zero",
            "instant_death",
            "conditional"
          ],
          "description": "Death trigger type"
        },
        "message": {
          "type": "string",
          "description": "Death message/reason"
        }
      }
    },
      "StateCheckEvent": {
        "type": "object",
        "required": [
          "kind"
        ],
        "properties": {
          "kind": {
            "const": "state_check"
          },
          "conditionText": {
            "type": "string"
          },
          "key": {
            "type": "string"
          },
          "templateTarget": {
            "type": "string"
          },
          "templateOp": {
            "type": "string"
          },
          "templateValue": {
            "type": "string"
          },
          "choiceText": {
            "type": "string"
          },
          "has": {
            "$ref": "#/definitions/OutcomeRef"
        },
        "missing": {
          "$ref": "#/definitions/OutcomeRef"
        }
      }
    },
    "StateSetEvent": {
      "type": "object",
      "required": [
        "kind",
        "key",
        "value"
      ],
      "properties": {
        "kind": {
          "const": "state_set"
        },
        "key": {
          "type": "string"
        },
        "value": {
          "type": "string"
        },
        "sourceText": {
          "type": "string"
        }
      }
    },
    "InventoryStateEvent": {
      "type": "object",
      "required": [
        "kind",
        "action",
        "scope"
      ],
      "properties": {
        "kind": {
          "const": "inventory_state"
        },
        "action": {
          "type": "string",
          "enum": [
            "lose_all",
            "restore_all"
          ]
        },
        "scope": {
          "type": "string",
          "enum": [
            "possessions",
            "inventory"
          ]
        }
      }
    }
  }
}
