# Story: Pipeline Dashboard Validation Report Integration

**Status**: Done

---

## Acceptance Criteria
- `pipeline-visibility.html` shows the currently running module/stage in the "Overall Progress" panel at the top, making it immediately visible which stage is active without scrolling.
- The "Artifacts" panel includes a link to `validation_report.html` when it exists for the run (generated when the validation stage completes with `forensics: true`).
- When a run is complete, the dashboard displays summary validation statistics from `validation_report.json`:
  - Status (VALID/INVALID)
  - Total Sections
  - Missing sections count
  - No Text sections count
  - No Choices sections count
  - Broken Links count
  - Orphans count
- Summary stats include a link to the full `validation_report.html` for detailed forensic analysis.
- Summary stats appear in a dedicated validation summary card or section, clearly visible after run completion.

## Tasks
- [x] Enhance "Overall Progress" card to display the currently running stage/module name when run status is "running".
- [x] Add logic to detect and link to `validation_report.html` in the Artifacts panel (check for `<run_dir>/validation_report.html` or find via stage artifact that matches `validation_report.json` → `.html`).
- [x] Add function to read `validation_report.json` from run directory and extract summary statistics.
- [x] Create validation summary display (card or section) that shows key metrics from `validation_report.json` when run is complete.
- [x] Add link from summary stats to `validation_report.html` for full forensic report.
- [x] Handle gracefully when validation report doesn't exist (e.g., run hasn't reached validation stage yet, or validation failed to produce report).

## Notes
- Validation report HTML is generated by `tools/generate_forensic_html.py` when `validate_ff_engine_v2` runs with `forensics: true` parameter.
- The JSON report (`validation_report.json`) lives in the run root directory and contains:
  - `is_valid` (boolean)
  - `total_sections` (integer)
  - `missing_sections` (array)
  - `sections_with_no_text` (array)
  - `sections_with_no_choices` (array)
  - `forensics.broken_links` (object keys)
  - `forensics.orphans` (object keys)
- Dashboard should fetch `validation_report.json` via relative path from current run directory.
- Currently running stage can be determined by finding the stage with `status: "running"` in `pipeline_state.json` stages.
- Module name is available via `stages[stage_id].module_id`.

## Work Log

### 20251228-1445 — Implemented validation report integration

**Result:** Success — All acceptance criteria implemented and verified.

**Implementation Details:**
1. **Currently Running Stage Display:**
   - Modified "Overall Progress" card to display currently running stage name at the top
   - Uses `getRunningStageName()` to find the most recently updated "running" stage
   - Displays as "Currently Running: <stage_name>" when a stage is active
   - Falls back to "No stage currently running" when none are running

2. **Validation Report HTML Link Detection:**
   - Added detection logic in Artifacts panel for `validation_report.html`
   - Button appears in Artifacts card when HTML report exists (checked via fetch)
   - Button opens report in new tab when clicked
   - Gracefully handles case when report doesn't exist (button stays hidden)

3. **Validation JSON Parsing and Summary Display:**
   - Created `loadValidationReport()` async function to fetch and parse `validation_report.json`
   - Summary only displays when run is complete (status=done/failed/crashed OR all stages done)
   - Displays key validation metrics in a dedicated "Validation Summary" card:
     - Status (VALID/INVALID) with color-coded styling
     - Total Sections count
     - Missing sections count
     - No Text sections count
     - No Choices sections count
     - Broken Links count (from forensics)
     - Orphans count (from forensics)
   - Includes link to full forensic HTML report when available
   - Positioned before debug card for better visibility

**Files Modified:**
- `docs/pipeline-visibility.html` (docs/pipeline-visibility.html:1349, docs/pipeline-visibility.html:1380, docs/pipeline-visibility.html:1314)

**Testing:**
- Verified with run: `ff-ai-ocr-gpt51-pristine-fast-full`
- Confirmed validation_report.json (78KB) and validation_report.html (58KB) exist
- Run status is "done" with 23 stages
- HTTP server started on port 8765 for browser testing

**Next Steps:**
- User should verify in browser at http://localhost:8765/docs/pipeline-visibility.html
- All acceptance criteria met and ready for review
- Consider adding tests for edge cases (no validation report, partial reports, etc.)

