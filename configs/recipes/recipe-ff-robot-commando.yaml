# GPT‑5.1 AI‑first OCR pipeline with FAST extraction (pristine PDF) + Image Extraction
# Story 024: Adds illustration extraction and association to gamebook.json
# Based on: recipe-ff-ai-ocr-gpt51-pristine-fast.yaml
# Pristine PDF has 72 DPI embedded images - OCR quality validated at native resolution



stages:
  - id: extract_pdf_images_capped
    stage: extract
    module: extract_pdf_images_fast_v1
    out: pages_rendered_manifest.jsonl
    params:
      start: 1
      end: 228  # pristine PDF has 228 pages (1-up layout, no splitting needed)
      fallback_to_render: true
      fallback_dpi: 300
      target_line_height: 20  # Normalize to 20px x-height for optimal OCR quality/cost (story-102)

  - id: split_pages
    stage: extract
    module: split_pages_from_manifest_v1
    needs: [extract_pdf_images_capped]
    inputs:
      pages: extract_pdf_images_capped
    out: pages_split_manifest.jsonl

  - id: ocr_ai
    stage: extract
    module: ocr_ai_gpt51_v1
    needs: [split_pages]
    inputs:
      pages: split_pages
    out: pages_html.jsonl
    params:
      model: gpt-5.1
      ocr_hints: |
        - This is a Fighting Fantasy gamebook page.
        - Preserve section numbers as <h2> tags.
        - Multi-row choice tables should be represented as proper HTML tables with multiple <tr> rows.

  - id: crop_illustrations
    stage: extract
    module: crop_illustrations_guided_v1
    needs: [ocr_ai]
    inputs:
      ocr_manifest: ocr_ai
    out: illustration_manifest.jsonl
    params:
      transparency: true
      threshold: 230
      blur: 7

  - id: table_rescue
    stage: adapter
    module: table_rescue_html_v1
    needs: [ocr_ai]
    inputs:
      pages: ocr_ai
    out: pages_html_rescued.jsonl
    params:
      model: gpt-5.1
      max_pages: 10
      crop_bottom: 0.42
      rescue_hints: |
        - When options are presented in columns or rows, preserve the grid as a <table>.
        - Preserve row/column separation for repeated option lists and references.

  - id: detect_duplicate_pages
    stage: adapter
    module: detect_duplicate_pages_v1
    needs: [table_rescue]
    inputs:
      pages: table_rescue
    out: pages_html_deduped.jsonl
    params:
      similarity_threshold: 0.95
      min_tokens: 80
      max_lookback: 3
      max_page_gap: 3
      header_overlap_threshold: 0.88
      require_header_overlap: true
      allow_frontmatter_dedupe: false
      frontmatter_max_page: 30

  - id: html_blocks_raw
    stage: adapter
    module: html_to_blocks_v1
    needs: [detect_duplicate_pages]
    inputs:
      pages: detect_duplicate_pages
    out: page_blocks.jsonl

  - id: coarse_segment_html
    stage: portionize
    module: coarse_segment_html_v1
    needs: [html_blocks_raw]
    inputs:
      pages: html_blocks_raw
    out: coarse_segments.json

  - id: html_repair_loop
    stage: portionize
    module: detect_boundaries_html_loop_v1
    needs: [detect_duplicate_pages, coarse_segment_html]
    inputs:
      pages: detect_duplicate_pages
      coarse_segments: coarse_segment_html
    out: pages_html_repaired.jsonl
    params:
      min_section: 1
      max_section: 400
      allow_missing: true

  - id: html_blocks_repaired
    stage: adapter
    module: html_to_blocks_v1
    needs: [html_repair_loop]
    inputs:
      pages: html_repair_loop
    out: page_blocks_repaired.jsonl

  - id: detect_boundaries_html
    stage: portionize
    module: detect_boundaries_html_v1
    needs: [html_blocks_repaired, coarse_segment_html]
    inputs:
      pages: html_blocks_repaired
      coarse_segments: coarse_segment_html
    out: section_boundaries.jsonl
    params:
      include_background: true

  - id: portionize_html
    stage: portionize
    module: portionize_html_extract_v1
    needs: [html_blocks_repaired, detect_boundaries_html]
    inputs:
      pages: html_blocks_repaired
      boundaries: detect_boundaries_html
    out: portions_enriched.jsonl
    params:
      drop_raw_text: true

  - id: detect_section_range
    stage: transform
    module: detect_section_range_v1
    needs: [portionize_html, detect_duplicate_pages]
    inputs:
      portions: portionize_html
      pages: detect_duplicate_pages
    out: section_range.json

  - id: extract_combat_styles_frontmatter
    stage: transform
    module: extract_combat_styles_frontmatter_v1
    needs: [portionize_html, detect_duplicate_pages]
    inputs:
      pages: detect_duplicate_pages
      portions: portionize_html
    out: combat_styles.json
    params:
      model: gpt-5.1
      styles: "standard,hand,shooting,robot,vehicle"
      max_pages: 40

  - id: extract_combat
    stage: enrich
    module: extract_combat_v1
    needs: [portionize_html, html_blocks_repaired]
    inputs:
      portions: portionize_html
      pages: html_blocks_repaired
    out: portions_with_combat.jsonl
    params:
      model: gpt-4.1-mini
      use_ai: true
      max_ai_calls: 50

  - id: assign_combat_styles
    stage: transform
    module: assign_combat_styles_v1
    needs: [extract_combat, extract_combat_styles_frontmatter]
    inputs:
      input: extract_combat
      styles: extract_combat_styles_frontmatter
    out: portions_with_combat_styles.jsonl

  - id: extract_inventory
    stage: enrich
    module: extract_inventory_v1
    needs: [assign_combat_styles, html_blocks_repaired]
    inputs:
      portions: assign_combat_styles
      pages: html_blocks_repaired
    out: portions_with_inventory.jsonl
    params:
      model: gpt-4.1-mini
      use_ai: true
      max_ai_calls: 50

  - id: extract_stat_checks
    stage: enrich
    module: extract_stat_checks_v1
    needs: [extract_inventory, html_blocks_repaired]
    inputs:
      portions: extract_inventory
      pages: html_blocks_repaired
    out: portions_with_stats.jsonl
    params:
      model: gpt-4.1-mini
      use_ai: true
      max_ai_calls: 50

  - id: extract_stat_modifications
    stage: enrich
    module: extract_stat_modifications_v1
    needs: [extract_stat_checks, html_blocks_repaired]
    inputs:
      portions: extract_stat_checks
      pages: html_blocks_repaired
    out: portions_with_mods.jsonl
    params:
      model: gpt-4.1-mini
      use_ai: true
      max_ai_calls: 50

  - id: extract_choices
    stage: extract
    module: extract_choices_relaxed_v1
    needs: [extract_stat_modifications]
    inputs:
      pages: extract_stat_modifications
    out: portions_with_choices.jsonl

  - id: repair_choices
    stage: enrich
    module: choices_repair_relaxed_v1
    needs: [extract_choices]
    inputs:
      pages: html_blocks_repaired
      inputs: extract_choices
    out: portions_with_choices_repaired.jsonl
    params:
      model: gpt-5.1
      max_sources: 50
      max_calls: 50

  - id: validate_choice_text_alignment
    stage: validate
    module: validate_choice_text_alignment_v1
    needs: [repair_choices]
    inputs:
      portions: repair_choices
    out: choice_text_alignment_report.json

  - id: trace_orphans_text
    stage: validate
    module: trace_orphans_text_v1
    needs: [repair_choices]
    inputs:
      portions: repair_choices
    out: orphan_trace_report.json

  - id: validate_choice_links
    stage: enrich
    module: validate_choice_links_v1
    needs: [repair_choices, validate_choice_text_alignment, trace_orphans_text]
    inputs:
      pages: html_blocks_repaired
      input: repair_choices
    out: portions_with_choices_validated.jsonl
    params:
      model: gpt-4.1-mini
      max_ai_calls: 50
      check_multi_links: true
      alignment_report: validate_choice_text_alignment
      orphan_trace_report: trace_orphans_text

  - id: orphan_reocr_candidates
    stage: adapter
    module: orphan_reocr_candidates_v1
    needs: [validate_choice_links]
    inputs:
      portions: validate_choice_links
    out: portions_orphan_reocr_candidates.jsonl
    params:
      min_inbound: 2
      max_candidates: 80

  - id: repair_portions_orphan
    stage: clean
    module: repair_portions_v1
    needs: [orphan_reocr_candidates]
    inputs:
      portions: orphan_reocr_candidates
    out: portions_orphan_repaired.jsonl
    params:
      model: gpt-5.1
      max_repairs: 40
      max_images: 2
      require_hints: true
      strict_orphan_targets: true
      strict_orphan_model: gpt-5.2

  - id: extract_choices_repaired
    stage: extract
    module: extract_choices_relaxed_v1
    needs: [repair_portions_orphan]
    inputs:
      pages: repair_portions_orphan
    out: portions_with_choices.jsonl

  - id: repair_choices_repaired
    stage: enrich
    module: choices_repair_relaxed_v1
    needs: [extract_choices_repaired]
    inputs:
      pages: html_blocks_repaired
      inputs: extract_choices_repaired
    out: portions_with_choices_repaired_llm.jsonl
    params:
      model: gpt-5.1
      max_sources: 50
      max_calls: 50

  - id: validate_choice_text_alignment_repaired
    stage: validate
    module: validate_choice_text_alignment_v1
    needs: [repair_choices_repaired]
    inputs:
      portions: repair_choices_repaired
    out: choice_text_alignment_report_repaired.json

  - id: trace_orphans_text_repaired
    stage: validate
    module: trace_orphans_text_v1
    needs: [repair_choices_repaired]
    inputs:
      portions: repair_choices_repaired
    out: orphan_trace_report_repaired.json

  - id: validate_choice_links_repaired
    stage: enrich
    module: validate_choice_links_v1
    needs: [repair_choices_repaired, validate_choice_text_alignment_repaired, trace_orphans_text_repaired]
    inputs:
      pages: html_blocks_repaired
      input: repair_choices_repaired
    out: portions_with_choices_validated_repaired.jsonl
    params:
      model: gpt-4.1-mini
      max_ai_calls: 50
      check_multi_links: true
      alignment_report: validate_choice_text_alignment_repaired
      orphan_trace_report: trace_orphans_text_repaired

  - id: extract_state_refs
    stage: enrich
    module: extract_state_refs_v1
    needs: [validate_choice_links_repaired]
    inputs:
      pages: html_blocks_repaired
      portions: validate_choice_links_repaired
    out: portions_with_state_refs.jsonl
    params:
      map_ref_escalate: true
      map_ref_escalation_model: gpt-5.2
      map_ref_max_images: 2

  - id: validate_reachability
    stage: validate
    module: validate_holistic_reachability_v1
    needs: [extract_state_refs]
    inputs:
      portions: extract_state_refs
      section_count: detect_section_range
    out: reachability_report.json

  - id: detect_endings
    stage: enrich
    module: ending_guard_v1
    needs: [extract_state_refs]
    inputs:
      pages: html_blocks_repaired
      inputs: extract_state_refs
    out: portions_with_endings.jsonl
    params:
      model: gpt-5.1
      skip_ai: false
      # Auto-detects sections with is_gameplay=true and no choices

  - id: order_sequence
    stage: enrich
    module: sequence_order_v1
    needs: [detect_endings]
    inputs:
      portions: detect_endings
      pages: html_blocks_repaired
    out: portions_with_sequence.jsonl

  - id: report_pipeline_issues
    stage: adapter
    module: report_pipeline_issues_v1
    needs: [detect_endings]
    out: issues_report.jsonl

  - id: build_gamebook
    stage: build
    module: build_ff_engine_with_issues_v1
    needs: [report_pipeline_issues, order_sequence]
    inputs:
      portions: order_sequence
      issues_report: report_pipeline_issues
      combat_styles: extract_combat_styles_frontmatter
      section_count: detect_section_range
    out: gamebook_raw.json
    params:
      title: Deathtrap Dungeon
      author: Ian Livingstone
      emit_text: false
      emit_provenance_text: false
      allow_stubs: true

  - id: associate_illustrations
    stage: transform
    module: associate_illustrations_to_sections_v1
    needs: [build_gamebook, crop_illustrations, ocr_ai]
    inputs:
      gamebook: build_gamebook
      illustrations: crop_illustrations
      pages_html: ocr_ai
    out: gamebook_with_images.json
    params:
      image_base_path: images

  - id: clean_presentation
    stage: export
    module: clean_html_presentation_v1
    needs: [associate_illustrations]
    inputs:
      input: associate_illustrations
    out: gamebook.json
    params:
      preserve_original_html: true
      remove_section_headers: true
      remove_running_heads: true
      remove_page_numbers: true
      remove_images: true

  - id: apply_edgecase_patches
    stage: export
    module: apply_edgecase_patches_v1
    needs: [clean_presentation]
    inputs:
      input: clean_presentation
    out: gamebook_patched.json
    params:
      patches: edgecase_patches.jsonl
      allow-missing: true
      report-out: edgecase_patch_report.jsonl

  - id: forensics_gamebook
    stage: validate
    module: validate_ff_engine_v2
    needs: [apply_edgecase_patches, report_pipeline_issues, detect_endings, detect_boundaries_html, html_blocks_repaired, validate_reachability]
    inputs:
      gamebook: apply_edgecase_patches
      portions: detect_endings
      boundaries: detect_boundaries_html
      elements_core: html_blocks_repaired
      reachability_report: validate_reachability
    out: validation_report.json
    params:
      forensics: true

  - id: validate_gamebook_node
    stage: export
    module: validate_ff_engine_node_v1
    needs: [apply_edgecase_patches]
    inputs:
      input: apply_edgecase_patches
    out: gamebook_validation_node.json

  - id: validate_choice_completeness
    stage: validate
    module: validate_choice_completeness_v1
    needs: [apply_edgecase_patches]
    inputs:
      gamebook: apply_edgecase_patches
    out: choice_completeness_report.json
    params:
      max_discrepancy: 0
      expected_range: "1-400"

  - id: validate_game_ready
    stage: validate
    module: validate_game_ready_v1
    needs: [validate_gamebook_node, validate_choice_completeness, report_pipeline_issues, validate_reachability, apply_edgecase_patches]
    inputs:
      gamebook: apply_edgecase_patches
      choice_report: validate_choice_completeness
      reachability_report: validate_reachability
      engine_report: validate_gamebook_node
      issues_report: report_pipeline_issues
    out: game_ready_validation_report.json
    params:
      known_missing: "169,170"

  - id: package_game_ready
    stage: export
    module: package_game_ready_v1
    needs: [apply_edgecase_patches]
    inputs:
      gamebook: apply_edgecase_patches
    out: output
