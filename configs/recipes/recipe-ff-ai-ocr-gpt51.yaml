# GPT‑5.1 AI‑first OCR pipeline (HTML‑first)
# New modules only; existing OCR modules remain untouched.

run_id: ff-ai-ocr-gpt51
input:
  pdf: input/06 deathtrap dungeon.pdf
output_dir: output/runs/ff-ai-ocr-gpt51

stages:
  - id: split_pages
    stage: extract
    module: split_pages_v1
    out: pages_split_manifest.jsonl
    params:
      dpi: 300
      start: 1
      end: 113  # full book; override via settings for smoke runs

  - id: ocr_ai
    stage: extract
    module: ocr_ai_gpt51_v1
    needs: [split_pages]
    inputs:
      pages: split_pages
    out: pages_html.jsonl
    params:
      model: gpt-5.1
      ocr_hints: |
        - This book uses either running heads OR page numbers, not both on the same page.
        - In gameplay pages, section numbers are centered standalone digits (1–3 digits) and should be <h2>.
        - Do not treat running heads (e.g., \"16-17\") as section headers.

  - id: html_blocks_raw
    stage: adapter
    module: html_to_blocks_v1
    needs: [ocr_ai]
    inputs:
      pages: ocr_ai
    out: page_blocks.jsonl

  - id: coarse_segment_html
    stage: portionize
    module: coarse_segment_html_v1
    needs: [html_blocks_raw]
    inputs:
      pages: html_blocks_raw
    out: coarse_segments.json

  - id: html_repair_loop
    stage: portionize
    module: detect_boundaries_html_loop_v1
    needs: [ocr_ai, coarse_segment_html]
    inputs:
      pages: ocr_ai
      coarse_segments: coarse_segment_html
    out: pages_html_repaired.jsonl
    params:
      min_section: 1
      max_section: 400
      allow_missing: true

  - id: html_blocks_repaired
    stage: adapter
    module: html_to_blocks_v1
    needs: [html_repair_loop]
    inputs:
      pages: html_repair_loop
    out: page_blocks_repaired.jsonl

  - id: detect_boundaries_html
    stage: portionize
    module: detect_boundaries_html_v1
    needs: [html_blocks_repaired, coarse_segment_html]
    inputs:
      pages: html_blocks_repaired
      coarse_segments: coarse_segment_html
    out: section_boundaries.jsonl

  - id: portionize_html
    stage: portionize
    module: portionize_html_extract_v1
    needs: [html_blocks_repaired, detect_boundaries_html]
    inputs:
      pages: html_blocks_repaired
      boundaries: detect_boundaries_html
    out: portions_enriched.jsonl

  - id: extract_choices
    stage: extract
    module: extract_choices_relaxed_v1
    needs: [portionize_html]
    inputs:
      pages: portionize_html
    out: portions_with_choices.jsonl

  - id: repair_choices
    stage: enrich
    module: choices_repair_relaxed_v1
    needs: [extract_choices]
    inputs:
      pages: html_blocks_repaired
      inputs: extract_choices
    out: portions_with_choices_repaired.jsonl
    params:
      model: gpt-5.1
      max_sources: 50
      max_calls: 50

  - id: report_pipeline_issues
    stage: adapter
    module: report_pipeline_issues_v1
    needs: [repair_choices]
    out: issues_report.jsonl

  - id: build_gamebook
    stage: build
    module: build_ff_engine_with_issues_v1
    needs: [report_pipeline_issues, repair_choices]
    inputs:
      portions: repair_choices
      issues_report: report_pipeline_issues
    out: gamebook.json
    params:
      title: Deathtrap Dungeon
      author: Ian Livingstone

  - id: validate_gamebook
    stage: validate
    module: validate_gamebook_smoke_v1
    needs: [build_gamebook]
    inputs:
      gamebook: build_gamebook
    out: validation_report.json
