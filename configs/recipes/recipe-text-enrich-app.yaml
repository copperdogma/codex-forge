run_id: text-enrich-app
input:
  text_glob: input/text/**/*.md
output_dir: output/runs/text-enrich-app

stages:
  - id: extract_text
    stage: extract
    module: extract_text_v1
    params:
      input_glob: input/text/**/*.md

  - id: clean_pages
    stage: clean
    module: clean_llm_v1
    needs: [extract_text]
    params:
      model: gpt-4.1-mini
      boost_model: gpt-5
      min_conf: 0.6

  - id: portionize_page
    stage: portionize
    module: portionize_page_v1
    needs: [clean_pages]
    params:
      group_size: 1
      confidence: 0.5

  - id: consensus_spanfill
    stage: consensus
    module: consensus_spanfill_v1
    needs: [portionize_page]
    params:
      min_conf: 0.3

  - id: dedupe_main
    stage: dedupe
    module: dedupe_ids_v1
    needs: [consensus_spanfill]

  - id: normalize_main
    stage: normalize
    module: normalize_ids_v1
    needs: [dedupe_main]

  - id: resolve_main
    stage: resolve
    module: resolve_overlaps_v1
    needs: [normalize_main]

  - id: build_main
    stage: build
    module: build_portions_v1
    needs: [clean_pages, resolve_main]
    inputs:
      pages: clean_pages
      portions: resolve_main

  - id: enrich_main
    stage: enrich
    module: enrich_struct_v1
    needs: [resolve_main, clean_pages]
    inputs:
      pages: clean_pages
      portions: resolve_main
    params:
      model: gpt-4.1-mini
      boost_model: gpt-5
      text_field: clean_text
      max_chars: 1200

  - id: app_data
    stage: export
    module: build_appdata_v1
    needs: [enrich_main]
    inputs:
      enriched: enrich_main
    out: data.json
    params:
      run_id: text-enrich-app
