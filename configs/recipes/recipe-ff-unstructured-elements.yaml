# DEPRECATED: superseded by recipe-ff-canonical.yaml
# Fighting Fantasy pipeline using Unstructured intake with element-aware portionization
#
# This recipe uses the new element-aware portionizer that works directly with elements
# instead of converting to pages. Expected to find 4x more sections.

run_id: ff-unstructured-elements
input:
  pdf: input/06 deathtrap dungeon.pdf
output_dir: output/runs/ff-unstructured-elements
stages:
  # Stage 1: Unstructured intake → elements.jsonl
  - id: unstructured_intake
    stage: intake
    module: unstructured_pdf_intake_v1
    params:
      strategy: hi_res  # Better element granularity on ARM64
      infer_table_structure: false
      extract_images: false
      save_raw: false

  # Stage 2: Portionize using element-aware approach
  - id: portionize_elements
    stage: portionize
    module: portionize_elements_v1
    needs: [unstructured_intake]

  # Stage 3: Consensus voting
  # Element-based portionizer creates one hypothesis per section, but we still need
  # consensus to convert portion_hyp_v1 → locked_portion_v1 schema
  - id: consensus_main
    stage: consensus
    module: consensus_vote_v1
    needs: [portionize_elements]
    params:
      min_conf: 0.55

  # Stage 4: Dedupe IDs
  - id: dedupe_main
    stage: dedupe
    module: dedupe_ids_v1
    needs: [consensus_main]

  # Stage 5: Normalize IDs
  - id: normalize_main
    stage: normalize
    module: normalize_ids_v1
    needs: [dedupe_main]

  # Stage 6: Resolve overlaps - Should have minimal overlaps now with fixed page spans
  - id: resolve_main
    stage: resolve
    module: resolve_overlaps_v1
    needs: [normalize_main]

  # Stage 7: Enrich sections
  - id: enrich_sections
    stage: enrich
    module: section_enrich_v1
    needs: [unstructured_intake, resolve_main]
    inputs:
      pages: unstructured_intake
      portions: resolve_main

  # Stage 8: Build FF Engine JSON
  - id: build_ff_engine
    stage: build
    module: build_ff_engine_v1
    needs: [unstructured_intake, enrich_sections]
    out: gamebook.json
    inputs:
      pages: unstructured_intake
      portions: enrich_sections
    params:
      title: "Deathtrap Dungeon"
      author: "Ian Livingstone"
      start_section: "1"
      format_version: "1.0.0"

  # Stage 9: Validate output
  - id: validate_ff_engine
    stage: export
    module: validate_ff_engine_node_v1
    needs: [build_ff_engine]
    out: gamebook_validation_node.json
    inputs:
      input: build_ff_engine
    params:
      validator_dir: modules/validate/validate_ff_engine_node_v1/validator
      node_bin: node
