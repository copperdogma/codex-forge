# Smoke test recipe for Fighting Fantasy AI pipeline
# Uses pre-generated stubs to bypass expensive API calls.



stages:
  - id: load_blocks
    stage: extract
    module: load_artifact_v1
    out: pages_clean.jsonl
    params:
      path: testdata/smoke/ff/pages_clean.jsonl
      out: pages_clean.jsonl
      schema_version: clean_page_v1

  - id: convert_to_blocks
    stage: adapter
    module: text_to_html_blocks_v1
    needs: [load_blocks]
    inputs:
      pages: load_blocks
    out: page_blocks.jsonl

  - id: load_boundaries
    stage: extract
    module: load_artifact_v1
    out: section_boundaries.jsonl
    params:
      path: testdata/smoke/ff/section_boundaries_stub.jsonl
      out: section_boundaries.jsonl
      schema_version: section_boundary_v1

  - id: portionize_html
    stage: portionize
    module: portionize_html_extract_v1
    needs: [convert_to_blocks, load_boundaries]
    inputs:
      pages: convert_to_blocks
      boundaries: load_boundaries
    out: portions_enriched.jsonl
    params:
      emit_raw_text: true

  - id: detect_section_range
    stage: transform
    module: detect_section_range_v1
    needs: [portionize_html]
    inputs:
      portions: portionize_html
      pages: convert_to_blocks
    out: section_range.json

  - id: extract_combat_styles_frontmatter
    stage: transform
    module: extract_combat_styles_frontmatter_v1
    needs: [portionize_html, convert_to_blocks]
    inputs:
      pages: convert_to_blocks
      portions: portionize_html
    out: combat_styles.json
    params:
      model: gpt-5.1
      max_pages: 10

  - id: extract_combat
    stage: enrich
    module: extract_combat_v1
    needs: [portionize_html, convert_to_blocks]
    inputs:
      portions: portionize_html
      pages: convert_to_blocks
    out: portions_with_combat.jsonl
    params:
      model: gpt-4.1-mini
      use_ai: false # skip AI in smoke
      max_ai_calls: 0

  - id: assign_combat_styles
    stage: transform
    module: assign_combat_styles_v1
    needs: [extract_combat, extract_combat_styles_frontmatter]
    inputs:
      input: extract_combat
      styles: extract_combat_styles_frontmatter
    out: portions_with_combat_styles.jsonl

  - id: extract_inventory
    stage: enrich
    module: extract_inventory_v1
    needs: [assign_combat_styles, convert_to_blocks]
    inputs:
      portions: assign_combat_styles
      pages: convert_to_blocks
    out: portions_with_inventory.jsonl
    params:
      model: gpt-4.1-mini
      use_ai: false # skip AI in smoke
      max_ai_calls: 0

  - id: extract_stat_checks
    stage: enrich
    module: extract_stat_checks_v1
    needs: [extract_inventory, convert_to_blocks]
    inputs:
      portions: extract_inventory
      pages: convert_to_blocks
    out: portions_with_stats.jsonl
    params:
      model: gpt-4.1-mini
      use_ai: false # skip AI in smoke
      max_ai_calls: 0

  - id: extract_stat_modifications
    stage: enrich
    module: extract_stat_modifications_v1
    needs: [extract_stat_checks, convert_to_blocks]
    inputs:
      portions: extract_stat_checks
      pages: convert_to_blocks
    out: portions_with_mods.jsonl
    params:
      model: gpt-4.1-mini
      use_ai: false # skip AI in smoke
      max_ai_calls: 0

  - id: extract_choices
    stage: extract
    module: extract_choices_relaxed_v1
    needs: [extract_stat_modifications]
    inputs:
      pages: extract_stat_modifications
    out: portions_with_choices.jsonl

  - id: validate_choice_links
    stage: enrich
    module: validate_choice_links_v1
    needs: [extract_choices, convert_to_blocks]
    inputs:
      pages: convert_to_blocks
      input: extract_choices
    out: portions_with_choices_validated.jsonl
    params:
      model: gpt-4.1-mini
      max_ai_calls: 0 # skip AI in smoke
      check_multi_links: true

  - id: validate_reachability
    stage: validate
    module: validate_holistic_reachability_v1
    needs: [validate_choice_links]
    inputs:
      portions: validate_choice_links
      section_count: detect_section_range
    out: reachability_report.json

  - id: detect_endings
    stage: enrich
    module: ending_guard_v1
    needs: [validate_choice_links, convert_to_blocks]
    inputs:
      pages: convert_to_blocks
      inputs: validate_choice_links
    out: portions_with_endings.jsonl
    params:
      model: gpt-5.1
      skip_ai: true # support skip_ai in ending_guard

  - id: report_pipeline_issues
    stage: adapter
    module: report_pipeline_issues_v1
    needs: [detect_endings]
    out: issues_report.jsonl

  - id: build_gamebook
    stage: build
    module: build_ff_engine_with_issues_v1
    needs: [report_pipeline_issues, detect_endings]
    inputs:
      portions: detect_endings
      issues_report: report_pipeline_issues
      combat_styles: extract_combat_styles_frontmatter
      section_count: detect_section_range
    out: gamebook_raw.json
    params:
      title: Smoke Test Book
      author: Ryan North
      emit_text: false
      emit_provenance_text: false
      allow_stubs: true
      expected_range: 3-8

  - id: clean_presentation
    stage: export
    module: clean_html_presentation_v1
    needs: [build_gamebook]
    inputs:
      input: build_gamebook
    out: gamebook.json
    params:
      preserve_original_html: true
      remove_section_headers: true
      remove_running_heads: true
      remove_page_numbers: true
      remove_images: true

  - id: apply_edgecase_patches
    stage: export
    module: apply_edgecase_patches_v1
    needs: [clean_presentation]
    inputs:
      input: clean_presentation
    out: gamebook_patched.json
    params:
      patches: edgecase_patches.jsonl
      allow-missing: true
      report-out: edgecase_patch_report.jsonl

  - id: validate_gamebook
    stage: validate
    module: validate_ff_engine_v2
    needs: [apply_edgecase_patches, report_pipeline_issues, detect_endings, load_boundaries, convert_to_blocks, validate_reachability]
    inputs:
      gamebook: apply_edgecase_patches
      portions: detect_endings
      boundaries: load_boundaries
      elements_core: convert_to_blocks
      reachability_report: validate_reachability
    out: validation_report.json
    params:
      forensics: true
      expected_range_start: 3
      expected_range_end: 8
